{% extends "base.html" %}

{% block title %}Server Operations - Dynamic Servers{% endblock %}

<!-- Hidden CSRF Token Field -->
<input type="hidden" id="csrf_token_field" name="csrf_token" value="{{ csrf_token() }}"}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="display-6 mb-0">
                    <i class="fas fa-tools text-primary me-2"></i>Server Operations
                </h1>
                <p class="text-muted">Manage server backups, updates, and system operations</p>
            </div>
            <div>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bulkOperationModal">
                    <i class="fas fa-tasks me-1"></i>Bulk Operations
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Operations Summary -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-0 bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="h4 mb-0">{{ servers|length }}</div>
                        <small>Total Servers</small>
                    </div>
                    <i class="fas fa-server fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="h4 mb-0">{{ servers|length }}</div>
                        <small>Running Servers</small>
                    </div>
                    <i class="fas fa-play fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="h4 mb-0">5</div>
                        <small>Pending Updates</small>
                    </div>
                    <i class="fas fa-clock fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="h4 mb-0">12</div>
                        <small>Recent Backups</small>
                    </div>
                    <i class="fas fa-database fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filter Controls -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0">
            <div class="card-body">
                <form id="filter-form" class="row g-3">
                    <div class="col-md-4">
                        <label for="search" class="form-label">Search</label>
                        <input type="text" class="form-control" id="search" name="search" 
                               placeholder="Server name, IP, domain...">
                    </div>
                    <div class="col-md-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" name="status">
                            <option value="">All Statuses</option>
                            <option value="running">Running</option>
                            <option value="stopped">Stopped</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="project" class="form-label">Project</label>
                        <select class="form-select" id="project" name="project">
                            <option value="">All Projects</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}">{{ project.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary" id="filter-btn">
                                <i class="fas fa-search me-1" id="filter-icon"></i>
                                <span id="filter-text">Filter</span>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="clear-btn">
                                <i class="fas fa-times me-1"></i>Clear
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Servers List -->
<div class="card border-0">
    <div class="card-header bg-gradient">
        <h5 class="card-title mb-0">
            <i class="fas fa-server me-2"></i>Server Management <small class="text-muted">{{ servers|length }} servers</small>
        </h5>
    </div>
    <div class="card-body p-0">
        <div id="servers-content">
        {% if servers %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAll">
                        </th>
                        <th>Server</th>
                        <th>Project</th>
                        <th>Domain</th>
                        <th>Last Backup</th>
                        <th>Last Update</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for server in servers %}
                    <tr>
                        <td>
                            <input type="checkbox" class="server-checkbox" value="{{ server.id }}">
                        </td>
                        <td>
                            <div class="fw-bold">{{ server.name }}</div>
                            <small class="text-muted">{{ server.server_type }} â€¢ {{ server.public_ip or 'No IP' }}</small>
                        </td>
                        <td>
                            {% if server.project %}
                            <span class="badge bg-secondary">{{ server.project.name }}</span>
                            {% else %}
                            <span class="text-muted">No Project</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if server.reverse_dns %}
                                {% if server.reverse_dns.startswith('static.') %}
                                <a href="http://{{ server.public_ip }}" target="_blank" class="text-decoration-none">
                                    <small class="text-info">{{ server.public_ip }}</small>
                                    <i class="fas fa-external-link-alt ms-1" style="font-size: 10px;"></i>
                                </a>
                                {% else %}
                                <a href="https://{{ server.reverse_dns }}" target="_blank" class="text-decoration-none">
                                    <small class="text-info">{{ server.reverse_dns }}</small>
                                    <i class="fas fa-external-link-alt ms-1" style="font-size: 10px;"></i>
                                </a>
                                {% endif %}
                            {% else %}
                            <span class="text-muted">No domain</span>
                            {% endif %}
                        </td>
                        <td>
                            {% set last_backup = server.backups | selectattr("completed_at") | sort(attribute='completed_at', reverse=True) | first %}
                            {% if last_backup and last_backup.completed_at %}
                                <small class="text-success">{{ (last_backup.completed_at | cairo_time).strftime('%Y-%m-%d %H:%M') }}</small>
                                <br><small class="badge bg-{{ 'success' if last_backup.status == 'completed' else 'danger' }}">{{ last_backup.status }}</small>
                            {% else %}
                                <small class="text-muted">Never</small>
                            {% endif %}
                        </td>
                        <td>
                            {% set last_update = server.system_updates | selectattr("completed_at") | sort(attribute='completed_at', reverse=True) | first %}
                            {% if last_update and last_update.completed_at %}
                                <small class="text-success">{{ (last_update.completed_at | cairo_time).strftime('%Y-%m-%d %H:%M') }}</small>
                                <br><small class="badge bg-{{ 'success' if last_update.status == 'completed' else 'danger' }}">{{ last_update.status }}</small>
                            {% else %}
                                <small class="text-muted">Never</small>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-success btn-sm" 
                                        onclick="initiateBackup({{ server.id }})" 
                                        title="Start Backup">
                                    <i class="fas fa-database"></i>
                                </button>
                                <button type="button" class="btn btn-outline-warning btn-sm" 
                                        onclick="initiateUpdate({{ server.id }})" 
                                        title="System Update">
                                    <i class="fas fa-arrow-up"></i>
                                </button>
                                {% if server.public_ip %}
                                <button type="button" class="btn btn-outline-info btn-sm" 
                                        onclick="copySQLTunnel('{{ server.public_ip }}')" 
                                        title="Copy SQL Tunnel Command">
                                    <i class="fas fa-terminal"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" 
                                        onclick="downloadLogs('{{ server.public_ip }}', '{{ server.reverse_dns or '' }}')" 
                                        title="Download Project Logs">
                                    <i class="fas fa-download"></i>
                                </button>
                                {% endif %}
                                {% if current_user.is_admin or (current_user.role.name == 'TECHNICAL_AGENT' and current_user.is_manager) %}
                                <a href="{{ url_for('server_detail', server_id=server.id) }}" 
                                   class="btn btn-outline-primary btn-sm" title="Details">
                                    <i class="fas fa-eye"></i>
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5" id="no-servers-message">
            <i class="fas fa-server fa-4x text-muted mb-3"></i>
            <h3 class="text-muted">No Servers Available</h3>
            <p class="text-muted">No servers found for management operations. Sync servers from your Hetzner projects first.</p>
            <a href="{{ url_for('hetzner_projects') }}" class="btn btn-primary">
                <i class="fas fa-sync me-1"></i>Sync Servers
            </a>
        </div>
        {% endif %}
        </div>
    </div>
</div>

<!-- Custom Confirmation Modal -->
<div class="modal fade" id="confirmActionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    <span id="confirmTitle">Confirm Action</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <div class="mb-3">
                    <i class="fas fa-server fa-3x text-primary mb-3"></i>
                </div>
                <h6 id="confirmMessage" class="mb-3">Are you sure you want to perform this action?</h6>
                <p class="text-muted small mb-0" id="confirmDetails"></p>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="confirmActionBtn">
                    <i class="fas fa-check me-1"></i>Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Operations Modal -->
<div class="modal fade" id="bulkOperationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Server Operations</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Select Operation</label>
                    <select class="form-control" id="bulkOperation">
                        <option value="">Choose operation type</option>
                        <option value="backup">Database Backup</option>
                        <option value="update">System Update</option>
                        <option value="health">Health Check</option>
                        <option value="restart">Restart Services</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Schedule</label>
                    <select class="form-control" id="bulkSchedule">
                        <option value="now">Execute Now</option>
                        <option value="maintenance">During Maintenance Window</option>
                        <option value="custom">Custom Schedule</option>
                    </select>
                </div>
                
                <div class="mb-3" id="customSchedule" style="display: none;">
                    <label class="form-label">Custom Date & Time</label>
                    <input type="datetime-local" class="form-control" id="scheduleDateTime">
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Selected Servers:</strong> <span id="selectedCount">0</span> servers
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="executeBulkOperation()">
                    <i class="fas fa-play me-1"></i>Execute Operation
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Select All functionality
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.server-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = this.checked);
    updateSelectedCount();
});

// Update selected count
function updateSelectedCount() {
    const selected = document.querySelectorAll('.server-checkbox:checked').length;
    document.getElementById('selectedCount').textContent = selected;
}

// Add event listeners to individual checkboxes
document.querySelectorAll('.server-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', updateSelectedCount);
});

// Custom schedule toggle
document.getElementById('bulkSchedule').addEventListener('change', function() {
    const customDiv = document.getElementById('customSchedule');
    customDiv.style.display = this.value === 'custom' ? 'block' : 'none';
});

// Individual server operations
function initiateBackup(serverId) {
    // Get server name from the table row
    const serverRow = document.querySelector(`input[value="${serverId}"]`)?.closest('tr');
    const serverName = serverRow?.querySelector('td:nth-child(2) .fw-bold')?.textContent || 'Unknown Server';
    
    showConfirmModal(
        'Start Database Backup',
        `Start backup process for ${serverName}?`,
        'This will execute the backup script via SSH.',
        () => {
            // Find the backup button for this server and update it
            const backupButton = document.querySelector(`button[onclick="initiateBackup(${serverId})"]`);
            executeServerAction('/server/' + serverId + '/backup', {
                database_name: 'main',
                backup_type: 'full'
            }, backupButton, serverId, 'backup');
        }
    );
}

function initiateUpdate(serverId) {
    // Get server name from the table row
    const serverRow = document.querySelector(`input[value="${serverId}"]`)?.closest('tr');
    const serverName = serverRow?.querySelector('td:nth-child(2) .fw-bold')?.textContent || 'Unknown Server';
    
    showConfirmModal(
        'Execute Deployment',
        `Run deployment script for ${serverName}?`,
        'This will execute the Nova HR Docker deployment script.',
        () => {
            // Find the update button for this server and update it
            const updateButton = document.querySelector(`button[onclick="initiateUpdate(${serverId})"]`);
            executeServerAction('/server/' + serverId + '/update', {
                update_type: 'deployment',
                description: 'Nova HR Docker deployment script execution'
            }, updateButton, serverId, 'update');
        }
    );
}



// Pretty confirmation modal
function showConfirmModal(title, message, details, onConfirm) {
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmMessage').textContent = message;
    document.getElementById('confirmDetails').textContent = details;
    
    const modal = new bootstrap.Modal(document.getElementById('confirmActionModal'));
    const confirmBtn = document.getElementById('confirmActionBtn');
    
    // Remove any existing event listeners
    confirmBtn.replaceWith(confirmBtn.cloneNode(true));
    const newConfirmBtn = document.getElementById('confirmActionBtn');
    
    // Add new event listener
    newConfirmBtn.addEventListener('click', () => {
        modal.hide();
        onConfirm();
    });
    
    modal.show();
}

// Helper function to execute server actions with CSRF token via AJAX
function executeServerAction(actionUrl, data = {}, button = null, serverId = null, actionType = null) {
    // Disable button and show loading state
    if (button) {
        button.disabled = true;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
        button.dataset.originalText = originalText;
    }
    
    // Get CSRF token
    let tokenValue = null;
    const csrfToken = document.querySelector('meta[name=csrf-token]');
    if (csrfToken) {
        tokenValue = csrfToken.getAttribute('content');
    } else {
        const csrfTokenField = document.getElementById('csrf_token_field');
        if (csrfTokenField) {
            tokenValue = csrfTokenField.value;
        } else {
            const existingToken = document.querySelector('input[name=csrf_token]');
            if (existingToken) {
                tokenValue = existingToken.value;
            }
        }
    }
    
    // Prepare form data
    const formData = new FormData();
    if (tokenValue) {
        formData.append('csrf_token', tokenValue);
    }
    
    Object.entries(data).forEach(([key, value]) => {
        formData.append(key, value);
    });
    
    // Make AJAX request
    fetch(actionUrl, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        }
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    })
    .then(data => {
        if (data.success) {
            showNotification('Success!', data.message, 'success');
            // Update timestamp in the table
            updateTimestamp(serverId, actionType, data.timestamp);
        } else {
            showNotification('Error', data.message || 'Action failed', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error', 'Action failed: ' + error.message, 'danger');
    })
    .finally(() => {
        // Re-enable button
        if (button) {
            button.disabled = false;
            button.innerHTML = button.dataset.originalText || button.innerHTML;
        }
    });
}

// Copy SQL Tunnel Command
function copySQLTunnel(serverIp) {
    const tunnelCommand = `ssh -N -L 1533:127.0.0.1:1433 sqltunnel@${serverIp}`;
    
    // Try to use the modern Clipboard API
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(tunnelCommand).then(() => {
            showNotification('Copied!', 'SQL Tunnel command copied to clipboard', 'success');
        }).catch(err => {
            console.error('Failed to copy: ', err);
            fallbackCopyTextToClipboard(tunnelCommand);
        });
    } else {
        // Fallback for older browsers or non-secure contexts
        fallbackCopyTextToClipboard(tunnelCommand);
    }
}

// Fallback copy method
function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showNotification('Copied!', 'SQL Tunnel command copied to clipboard', 'success');
        } else {
            showSQLTunnelModal(text);
        }
    } catch (err) {
        console.error('Fallback copy failed: ', err);
        showSQLTunnelModal(text);
    }
    
    document.body.removeChild(textArea);
}

// Show modal with command if copying fails
function showSQLTunnelModal(command) {
    const modalHtml = `
        <div class="modal fade" id="sqlTunnelModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-terminal me-2"></i>SQL Tunnel Command
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="text-muted mb-3">Copy the command below to establish an SQL tunnel:</p>
                        <div class="bg-dark text-light p-3 rounded">
                            <code class="text-light">${command}</code>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                This command creates a secure SSH tunnel on port 1533 for SQL connections.
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="selectCommand()">Select All</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('sqlTunnelModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('sqlTunnelModal'));
    modal.show();
    
    // Remove modal from DOM when hidden
    document.getElementById('sqlTunnelModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

// Select command text in modal
function selectCommand() {
    const codeElement = document.querySelector('#sqlTunnelModal code');
    if (codeElement) {
        const range = document.createRange();
        range.selectNode(codeElement);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
    }
}

// Download project logs
function downloadLogs(serverIp, reverseDns) {
    let logsUrl;
    let protocol = 'http'; // Default to HTTP
    let hostname = serverIp;
    
    // Check if we have a reverse DNS
    if (reverseDns && reverseDns.trim() !== '') {
        if (reverseDns.startsWith('static.')) {
            // Hetzner static domain - use HTTP with IP address
            hostname = serverIp;
            protocol = 'http';
        } else {
            // Custom domain - use HTTPS with domain
            hostname = reverseDns;
            protocol = 'https';
        }
    } else {
        // No domain - use IP with HTTP
        hostname = serverIp;
        protocol = 'http';
    }
    
    logsUrl = `${protocol}://${hostname}/dotnet/api/logs/download-all`;
    
    showNotification('Downloading...', `Opening logs download from ${hostname}`, 'info');
    
    // Create a temporary link to trigger download
    const link = document.createElement('a');
    link.href = logsUrl;
    link.target = '_blank';
    link.download = `logs-${hostname}-${new Date().toISOString().split('T')[0]}.zip`;
    
    // Add to DOM temporarily and click
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Show success notification after a brief delay
    setTimeout(() => {
        showNotification('Download Started', `Logs download initiated from ${hostname}`, 'success');
    }, 500);
}

// Show toast notifications
function showNotification(title, message, type = 'info') {
    // Create toast container if it doesn't exist
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    // Create toast
    const toastId = 'toast-' + Date.now();
    const toastHTML = `
        <div id="${toastId}" class="toast align-items-center text-bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <strong>${title}</strong><br>${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    
    // Show toast
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 4000 });
    toast.show();
    
    // Remove toast after hiding
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}

// Convert timestamp to relative time (e.g., "2 minutes ago")
function getRelativeTime(timestamp) {
    if (!timestamp) return 'Never';
    
    // Get current time
    const now = new Date();
    
    // Parse the Cairo timestamp 
    // The timestamp "2025-09-09 14:20" is already in Cairo time
    const timestampParts = timestamp.match(/(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2})/);
    if (!timestampParts) return 'Invalid time';
    
    const [, year, month, day, hour, minute] = timestampParts;
    
    // Create the timestamp date directly (this will be interpreted in user's local timezone)
    const timestampDate = new Date(
        parseInt(year),
        parseInt(month) - 1, // JavaScript months are 0-indexed
        parseInt(day),
        parseInt(hour),
        parseInt(minute)
    );
    
    const diffMs = now - timestampDate;
    const diffSeconds = Math.floor(diffMs / 1000);
    
    if (diffSeconds < 60) {
        return 'Just now';
    } else if (diffSeconds < 3600) { // Less than 1 hour
        const minutes = Math.floor(diffSeconds / 60);
        return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
    } else if (diffSeconds < 86400) { // Less than 24 hours
        const hours = Math.floor(diffSeconds / 3600);
        return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
    } else { // More than 24 hours
        const days = Math.floor(diffSeconds / 86400);
        return `${days} day${days !== 1 ? 's' : ''} ago`;
    }
}

// Update timestamp in the table
function updateTimestamp(serverId, actionType, timestamp) {
    if (!timestamp) return;
    
    // Find the table row for this server
    const serverRow = document.querySelector(`input[value="${serverId}"]`)?.closest('tr');
    if (!serverRow) return;
    
    // Determine which column to update (backup or update)
    let targetCell;
    if (actionType === 'backup') {
        // Find the "Last Backup" cell (5th column)
        targetCell = serverRow.cells[4]; // 0-indexed
    } else if (actionType === 'update') {
        // Find the "Last Update" cell (6th column) 
        targetCell = serverRow.cells[5]; // 0-indexed
    }
    
    if (targetCell) {
        // Convert to relative time
        const relativeTime = getRelativeTime(timestamp);
        
        // Update the cell content with relative timestamp
        targetCell.innerHTML = `
            <small class="text-success" title="${timestamp}">${relativeTime}</small>
            <br><small class="badge bg-success">completed</small>
        `;
        
        // Add a brief highlight animation
        targetCell.style.backgroundColor = '#d4edda';
        setTimeout(() => {
            targetCell.style.backgroundColor = '';
        }, 2000);
    }
}

function executeBulkOperation() {
    const operation = document.getElementById('bulkOperation').value;
    const schedule = document.getElementById('bulkSchedule').value;
    const selected = document.querySelectorAll('.server-checkbox:checked');
    
    if (!operation) {
        showSimpleAlert('Error', 'Please select an operation type', 'Choose backup, deployment, or health check');
        return;
    }
    
    if (selected.length === 0) {
        showSimpleAlert('Error', 'Please select at least one server', 'Check the servers you want to operate on');
        return;
    }
    
    const serverIds = Array.from(selected).map(cb => cb.value);
    
    showConfirmModal(
        `Bulk ${operation.charAt(0).toUpperCase() + operation.slice(1)}`,
        `Execute ${operation} on ${selected.length} selected servers?`,
        `This will run the ${operation} operation on all selected servers.`,
        () => {
            // TODO: Implement bulk operation
            showSimpleAlert('Success', `Bulk ${operation} initiated`, `Operation scheduled for ${selected.length} servers`);
            document.getElementById('bulkOperationModal').querySelector('.btn-close').click();
        }
    );
}

// Simple alert modal (for notifications)
function showSimpleAlert(title, message, details) {
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmMessage').textContent = message;
    document.getElementById('confirmDetails').textContent = details;
    
    const modal = new bootstrap.Modal(document.getElementById('confirmActionModal'));
    const confirmBtn = document.getElementById('confirmActionBtn');
    
    // Hide the confirm button for simple alerts
    confirmBtn.style.display = 'none';
    
    // Show only the cancel button (which becomes "OK")
    const cancelBtn = document.querySelector('#confirmActionModal .btn-secondary');
    cancelBtn.innerHTML = '<i class="fas fa-check me-1"></i>OK';
    
    modal.show();
    
    // Reset buttons when modal is hidden
    document.getElementById('confirmActionModal').addEventListener('hidden.bs.modal', function() {
        confirmBtn.style.display = 'inline-block';
        cancelBtn.innerHTML = '<i class="fas fa-times me-1"></i>Cancel';
    }, { once: true });
}

// Convert existing timestamps to relative time on page load
function convertExistingTimestamps() {
    // Wait a bit for DOM to be fully rendered
    setTimeout(() => {
        // Find all timestamp elements with text-success class (excludes status badges)
        const timestampElements = document.querySelectorAll('tbody tr td small.text-success');
        
        timestampElements.forEach(element => {
            if (element.textContent && element.textContent !== 'Never') {
                const absoluteTime = element.textContent.trim();
                
                // Check if it matches the timestamp format and hasn't been converted yet
                if (absoluteTime.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}$/) && !element.title) {
                    const relativeTime = getRelativeTime(absoluteTime);
                    element.title = absoluteTime; // Keep absolute time in tooltip
                    element.textContent = relativeTime;
                }
            }
        });
    }, 100); // Small delay to ensure DOM is ready
}

// Update all relative timestamps periodically
function refreshRelativeTimestamps() {
    const timestampElements = document.querySelectorAll('tbody tr td small[title]');
    timestampElements.forEach(element => {
        if (element.title && element.title.match(/\d{4}-\d{2}-\d{2} \d{2}:\d{2}/)) {
            const relativeTime = getRelativeTime(element.title);
            element.textContent = relativeTime;
        }
    });
}

// AJAX Filtering
document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('filter-form');
    const filterBtn = document.getElementById('filter-btn');
    const filterIcon = document.getElementById('filter-icon');
    const filterText = document.getElementById('filter-text');
    const clearBtn = document.getElementById('clear-btn');
    const serversContent = document.getElementById('servers-content');
    
    const searchInput = document.getElementById('search');
    const statusSelect = document.getElementById('status');
    const projectSelect = document.getElementById('project');
    
    let filterTimeout;
    
    function setFilterLoading(loading) {
        if (loading) {
            filterBtn.disabled = true;
            filterIcon.className = 'fas fa-spinner fa-spin me-1';
            filterText.textContent = 'Filtering...';
        } else {
            filterBtn.disabled = false;
            filterIcon.className = 'fas fa-search me-1';
            filterText.textContent = 'Filter';
        }
    }
    
    function renderServersTable(servers) {
        if (servers.length === 0) {
            return `
                <div class="text-center py-5" id="no-servers-message">
                    <i class="fas fa-server fa-4x text-muted mb-3"></i>
                    <h3 class="text-muted">No Servers Found</h3>
                    <p class="text-muted">No servers match your current filters.</p>
                </div>
            `;
        }
        
        let html = `
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th><input type="checkbox" id="selectAll"></th>
                            <th>Server</th>
                            <th>Project</th>
                            <th>Domain</th>
                            <th>Last Backup</th>
                            <th>Last Update</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        servers.forEach(server => {
            html += `
                <tr>
                    <td><input type="checkbox" class="server-checkbox" value="${server.id}"></td>
                    <td>
                        <div class="fw-bold">${server.name}</div>
                        <small class="text-muted">${server.server_type} â€¢ ${server.public_ip}</small>
                    </td>
                    <td>
                        ${server.project_name ? `<span class="badge bg-secondary">${server.project_name}</span>` : '<span class="text-muted">No Project</span>'}
                    </td>
                    <td>
                        ${server.reverse_dns ? `
                            ${server.reverse_dns.startsWith('static.') ? `
                                <a href="http://${server.public_ip}" target="_blank" class="text-decoration-none">
                                    <small class="text-info">${server.public_ip}</small>
                                    <i class="fas fa-external-link-alt ms-1" style="font-size: 10px;"></i>
                                </a>
                            ` : `
                                <a href="https://${server.reverse_dns}" target="_blank" class="text-decoration-none">
                                    <small class="text-info">${server.reverse_dns}</small>
                                    <i class="fas fa-external-link-alt ms-1" style="font-size: 10px;"></i>
                                </a>
                            `}
                        ` : '<span class="text-muted">No domain</span>'}
                    </td>
                    <td>
                        <small class="${server.last_backup !== 'Never' ? 'text-success' : 'text-muted'}">${server.last_backup}</small>
                        ${server.last_backup_status ? `<br><small class="badge bg-${server.last_backup_status === 'completed' ? 'success' : 'danger'}">${server.last_backup_status}</small>` : ''}
                    </td>
                    <td>
                        <small class="${server.last_update !== 'Never' ? 'text-success' : 'text-muted'}">${server.last_update}</small>
                        ${server.last_update_status ? `<br><small class="badge bg-${server.last_update_status === 'completed' ? 'success' : 'danger'}">${server.last_update_status}</small>` : ''}
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-success btn-sm" 
                                    onclick="initiateBackup(${server.id})" title="Start Backup">
                                <i class="fas fa-database"></i>
                            </button>
                            <button type="button" class="btn btn-outline-warning btn-sm" 
                                    onclick="initiateUpdate(${server.id})" title="System Update">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            ${server.public_ip && server.public_ip !== 'No IP' ? `
                                <button type="button" class="btn btn-outline-info btn-sm" 
                                        onclick="copySQLTunnel('${server.public_ip}')" title="Copy SQL Tunnel Command">
                                    <i class="fas fa-terminal"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" 
                                        onclick="downloadLogs('${server.public_ip}', '${server.reverse_dns || ''}')" title="Download Project Logs">
                                    <i class="fas fa-download"></i>
                                </button>
                            ` : ''}
                            <a href="/servers/${server.id}" class="btn btn-outline-primary btn-sm" title="Details">
                                <i class="fas fa-eye"></i>
                            </a>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        return html;
    }
    
    function performFilter() {
        setFilterLoading(true);
        
        const formData = new FormData(filterForm);
        const params = new URLSearchParams(formData);
        
        fetch('/server-operations?' + params, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            setFilterLoading(false);
            
            if (data.success) {
                serversContent.innerHTML = renderServersTable(data.servers);
                // Update count in header
                const headerCount = document.querySelector('.card-header h5 small');
                if (headerCount) {
                    headerCount.textContent = `${data.total_shown} servers`;
                }
                
                // Re-attach event listeners for new content
                reattachEventListeners();
            } else {
                console.error('Filter failed:', data.error);
            }
        })
        .catch(error => {
            setFilterLoading(false);
            console.error('Error:', error);
        });
    }
    
    function reattachEventListeners() {
        // Re-attach select all functionality
        const selectAllCheckbox = document.getElementById('selectAll');
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.server-checkbox');
                checkboxes.forEach(checkbox => checkbox.checked = this.checked);
                updateSelectedCount();
            });
        }
        
        // Re-attach individual checkbox listeners
        document.querySelectorAll('.server-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectedCount);
        });
        
        // Convert timestamps in newly loaded content
        convertExistingTimestamps();
    }
    
    // Handle form submission
    filterForm.addEventListener('submit', function(e) {
        e.preventDefault();
        performFilter();
    });
    
    // Real-time filtering with debounce
    function handleInputChange() {
        clearTimeout(filterTimeout);
        filterTimeout = setTimeout(performFilter, 500);
    }
    
    searchInput.addEventListener('input', handleInputChange);
    statusSelect.addEventListener('change', performFilter);
    projectSelect.addEventListener('change', performFilter);
    
    // Clear filters
    clearBtn.addEventListener('click', function() {
        searchInput.value = '';
        statusSelect.value = '';
        projectSelect.value = '';
        performFilter();
    });
    
    // Initialize relative timestamps
    convertExistingTimestamps();
    
    // Force refresh all timestamps immediately after loading to fix any issues
    setTimeout(() => {
        refreshRelativeTimestamps();
    }, 500);
    
    // Refresh relative timestamps every minute
    setInterval(refreshRelativeTimestamps, 60000);
});
</script>
{% endblock %}