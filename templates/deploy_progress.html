{% extends "base.html" %}

{% block title %}Deploying {{ request.server_name }} - Server Provisioning System{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header text-center">
                <h3 class="mb-0">
                    <i class="fas fa-rocket me-2"></i>Deploying Server
                </h3>
                <p class="text-muted mb-0">{{ request.server_name }}</p>
            </div>
            <div class="card-body">
                <!-- Server Information -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6 class="text-primary">Server Details</h6>
                        <ul class="list-unstyled">
                            <li><strong>Name:</strong> {{ request.server_name }}</li>
                            <li><strong>Type:</strong> {{ request.server_type.title() }}</li>
                            <li><strong>Hardware:</strong> {{ request.cpu_cores }}C / {{ request.memory_gb }}GB / {{ request.storage_gb }}GB</li>
                            <li><strong>OS:</strong> {{ request.operating_system }}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-info">Application Details</h6>
                        <ul class="list-unstyled">
                            <li><strong>Application:</strong> {{ request.application_name }}</li>
                            <li><strong>Type:</strong> {{ request.application_type.replace('-', ' ').title() }}</li>
                            {% if request.server_ip %}
                                <li><strong>IP Address:</strong> <code>{{ request.server_ip }}</code></li>
                            {% endif %}
                        </ul>
                    </div>
                </div>

                <!-- Progress Section -->
                <div class="text-center mb-4">
                    <div class="mb-3">
                        <div id="progress-icon" class="display-1 text-info">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </div>
                    
                    <div class="progress mb-3" style="height: 20px;">
                        <div id="progress-bar" 
                             class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                             role="progressbar" 
                             style="width: {{ request.deployment_progress }}%"
                             aria-valuenow="{{ request.deployment_progress }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            <span id="progress-text">{{ request.deployment_progress }}%</span>
                        </div>
                    </div>

                    <div id="status-message" class="h5 text-info mb-4">
                        Initializing deployment...
                    </div>
                </div>

                <!-- Deployment Log -->
                <div class="card bg-dark text-light">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-terminal me-2"></i>Deployment Log
                        </h6>
                    </div>
                    <div class="card-body" style="font-family: monospace; font-size: 0.9rem; max-height: 300px; overflow-y: auto;">
                        <div id="deployment-log">
                            <div class="log-entry">
                                <span class="text-success">[INFO]</span> Starting deployment process for {{ request.server_name }}...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="text-center mt-4">
                    <a href="{{ url_for('request_detail', request_id=request.request_id) }}" 
                       class="btn btn-outline-secondary me-2">
                        <i class="fas fa-eye me-2"></i>View Details
                    </a>
                    <a href="{{ url_for('admin_dashboard') }}" 
                       class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Admin
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let deploymentSteps = [
    "Initializing deployment process...",
    "Provisioning virtual machine...",
    "Installing operating system...",
    "Configuring network settings...",
    "Installing system updates...",
    "Setting up security configurations...",
    "Installing application dependencies...",
    "Deploying application code...",
    "Configuring application settings...",
    "Starting application services...",
    "Running health checks...",
    "Deployment completed successfully!"
];

let currentStep = 0;
let deploymentInterval;

function updateProgress() {
    fetch(`/api/deployment-progress/{{ request.request_id }}`)
        .then(response => response.json())
        .then(data => {
            const progress = data.progress;
            const status = data.status;
            const serverIp = data.server_ip;
            
            // Update progress bar
            document.getElementById('progress-bar').style.width = progress + '%';
            document.getElementById('progress-text').textContent = progress + '%';
            
            // Update status message based on progress
            if (progress < 100) {
                const stepIndex = Math.floor((progress / 100) * deploymentSteps.length);
                if (stepIndex < deploymentSteps.length && stepIndex !== currentStep) {
                    currentStep = stepIndex;
                    document.getElementById('status-message').textContent = deploymentSteps[stepIndex];
                    
                    // Add to deployment log
                    const logEntry = document.createElement('div');
                    logEntry.className = 'log-entry';
                    logEntry.innerHTML = `<span class="text-info">[INFO]</span> ${deploymentSteps[stepIndex]}`;
                    document.getElementById('deployment-log').appendChild(logEntry);
                    
                    // Auto-scroll to bottom
                    const logContainer = document.getElementById('deployment-log').parentElement;
                    logContainer.scrollTop = logContainer.scrollHeight;
                }
            } else if (status === 'deployed') {
                // Deployment completed
                clearInterval(deploymentInterval);
                
                // Update UI for completion
                document.getElementById('progress-icon').innerHTML = '<i class="fas fa-check-circle text-success"></i>';
                document.getElementById('status-message').textContent = 'Deployment completed successfully!';
                document.getElementById('status-message').className = 'h5 text-success mb-4';
                
                // Add completion log
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `<span class="text-success">[SUCCESS]</span> Server deployed successfully at ${serverIp}`;
                document.getElementById('deployment-log').appendChild(logEntry);
                
                // Remove progress bar animation
                const progressBar = document.getElementById('progress-bar');
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-success');
                
                // Auto-redirect after a delay
                setTimeout(() => {
                    window.location.href = `{{ url_for('request_detail', request_id=request.request_id) }}`;
                }, 3000);
            }
        })
        .catch(error => {
            console.error('Error fetching deployment progress:', error);
        });
}

// Start polling for progress updates
deploymentInterval = setInterval(updateProgress, 2000);

// Initial update
updateProgress();
</script>
{% endblock %}
