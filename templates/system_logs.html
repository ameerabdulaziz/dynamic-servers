{% extends "base.html" %}

{% block title %}System Logs - Dynamic Servers{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="display-6 mb-0">
                    <i class="fas fa-file-alt text-primary me-2"></i>System Logs
                </h1>
                <p class="text-muted">View deployment logs, system updates, and operation history</p>
            </div>
            <div>
                <button type="button" class="btn btn-outline-secondary" onclick="refreshLogs()">
                    <i class="fas fa-sync me-1"></i>Refresh
                </button>
                <button type="button" class="btn btn-outline-danger" onclick="clearLogs()">
                    <i class="fas fa-trash me-1"></i>Clear Logs
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Log Type Filter -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">Filter by Type</label>
                        <select class="form-control" id="logTypeFilter" onchange="filterLogs()">
                            <option value="">All Log Types</option>
                            <option value="deployment">Deployment Scripts</option>
                            <option value="backup">Database Backups</option>
                            <option value="system">System Updates</option>
                            <option value="error">Errors</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Server</label>
                        <select class="form-control" id="serverFilter" onchange="filterLogs()">
                            <option value="">All Servers</option>
                            {% for server in servers %}
                            <option value="{{ server.id }}">{{ server.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Updates Logs -->
<div class="card border-0 mb-4">
    <div class="card-header bg-gradient">
        <h5 class="card-title mb-0">
            <i class="fas fa-arrow-up me-2"></i>Deployment Script Executions
        </h5>
    </div>
    <div class="card-body p-0">
        {% if updates %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Server</th>
                        <th>Script Type</th>
                        <th>Status</th>
                        <th>Started</th>
                        <th>Duration</th>
                        <th>Initiated By</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for update in updates %}
                    <tr class="log-row" data-type="deployment" data-server="{{ update.server_id }}">
                        <td>
                            <div class="fw-bold">{{ update.server.name if update.server else 'Unknown' }}</div>
                            <small class="text-muted">{{ update.server.public_ip if update.server else 'N/A' }}</small>
                        </td>
                        <td>
                            <span class="badge bg-info">{{ update.update_type.title() }}</span>
                        </td>
                        <td>
                            {% if update.status == 'completed' %}
                            <span class="badge bg-success">Completed</span>
                            {% elif update.status == 'failed' %}
                            <span class="badge bg-danger">Failed</span>
                            {% elif update.status == 'running' %}
                            <span class="badge bg-warning">Running</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ update.status.title() }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <small>{{ update.started_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                        </td>
                        <td>
                            {% if update.completed_at and update.started_at %}
                            <small>{{ ((update.completed_at - update.started_at).total_seconds())|int }}s</small>
                            {% else %}
                            <small class="text-muted">-</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if update.initiated_by_user %}
                            <small>{{ update.initiated_by_user.username }}</small>
                            {% else %}
                            <small class="text-muted">System</small>
                            {% endif %}
                        </td>
                        <td>
                            <button type="button" class="btn btn-outline-primary btn-sm" 
                                    onclick="viewLogs({{ update.id }}, 'update')" title="View Logs">
                                <i class="fas fa-eye"></i>
                            </button>
                            {% if update.status == 'failed' %}
                            <button type="button" class="btn btn-outline-danger btn-sm" 
                                    onclick="viewErrors({{ update.id }}, 'update')" title="View Errors">
                                <i class="fas fa-exclamation-triangle"></i>
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-file-alt fa-4x text-muted mb-3"></i>
            <h3 class="text-muted">No Deployment Logs</h3>
            <p class="text-muted">No deployment script executions found.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Database Backups Logs -->
<div class="card border-0 mb-4">
    <div class="card-header bg-gradient">
        <h5 class="card-title mb-0">
            <i class="fas fa-database me-2"></i>Database Backup Operations
        </h5>
    </div>
    <div class="card-body p-0">
        {% if backups %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Database</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Started</th>
                        <th>Size</th>
                        <th>Initiated By</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for backup in backups %}
                    <tr class="log-row" data-type="backup" data-server="{{ backup.server_id }}">
                        <td>
                            <div class="fw-bold">{{ backup.database_name }}</div>
                            <small class="text-muted">{{ backup.server.name if backup.server else 'Local' }}</small>
                        </td>
                        <td>
                            <span class="badge bg-secondary">{{ backup.backup_type.title() }}</span>
                        </td>
                        <td>
                            {% if backup.status == 'completed' %}
                            <span class="badge bg-success">Completed</span>
                            {% elif backup.status == 'failed' %}
                            <span class="badge bg-danger">Failed</span>
                            {% elif backup.status == 'running' %}
                            <span class="badge bg-warning">Running</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ backup.status.title() }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <small>{{ backup.started_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                        </td>
                        <td>
                            {% if backup.file_size %}
                            <small>{{ "%.2f"|format(backup.file_size / 1024 / 1024) }} MB</small>
                            {% else %}
                            <small class="text-muted">-</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if backup.initiated_by_user %}
                            <small>{{ backup.initiated_by_user.username }}</small>
                            {% else %}
                            <small class="text-muted">System</small>
                            {% endif %}
                        </td>
                        <td>
                            <button type="button" class="btn btn-outline-primary btn-sm" 
                                    onclick="viewLogs({{ backup.id }}, 'backup')" title="View Logs">
                                <i class="fas fa-eye"></i>
                            </button>
                            {% if backup.status == 'failed' %}
                            <button type="button" class="btn btn-outline-danger btn-sm" 
                                    onclick="viewErrors({{ backup.id }}, 'backup')" title="View Errors">
                                <i class="fas fa-exclamation-triangle"></i>
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-database fa-4x text-muted mb-3"></i>
            <h3 class="text-muted">No Backup Logs</h3>
            <p class="text-muted">No database backup operations found.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Log Detail Modal -->
<div class="modal fade" id="logDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logModalTitle">Operation Logs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Execution Output:</label>
                    <pre id="executionLogs" class="bg-dark text-light p-3 rounded" style="max-height: 300px; overflow-y: auto;"></pre>
                </div>
                <div id="errorSection" style="display: none;">
                    <label class="form-label">Error Output:</label>
                    <pre id="errorLogs" class="bg-danger text-white p-3 rounded" style="max-height: 200px; overflow-y: auto;"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="downloadLogs()">
                    <i class="fas fa-download me-1"></i>Download Logs
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentLogId = null;
let currentLogType = null;

function filterLogs() {
    const typeFilter = document.getElementById('logTypeFilter').value;
    const serverFilter = document.getElementById('serverFilter').value;
    const rows = document.querySelectorAll('.log-row');
    
    rows.forEach(row => {
        const rowType = row.getAttribute('data-type');
        const rowServer = row.getAttribute('data-server');
        
        let showRow = true;
        
        if (typeFilter && rowType !== typeFilter) {
            showRow = false;
        }
        
        if (serverFilter && rowServer !== serverFilter) {
            showRow = false;
        }
        
        row.style.display = showRow ? '' : 'none';
    });
}

function viewLogs(logId, logType) {
    currentLogId = logId;
    currentLogType = logType;
    
    // Make AJAX request to get log details
    fetch(`/api/logs/${logType}/${logId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('logModalTitle').textContent = 
                `${logType.charAt(0).toUpperCase() + logType.slice(1)} Logs - ${data.description || 'Operation'}`;
            
            document.getElementById('executionLogs').textContent = 
                data.execution_log || 'No execution logs available';
            
            if (data.error_log) {
                document.getElementById('errorSection').style.display = 'block';
                document.getElementById('errorLogs').textContent = data.error_log;
            } else {
                document.getElementById('errorSection').style.display = 'none';
            }
            
            const modal = new bootstrap.Modal(document.getElementById('logDetailModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error fetching logs:', error);
            alert('Error loading logs. Please try again.');
        });
}

function viewErrors(logId, logType) {
    viewLogs(logId, logType); // Same as view logs, but will show errors section
}

function refreshLogs() {
    window.location.reload();
}

function clearLogs() {
    if (confirm('Clear all logs? This action cannot be undone.')) {
        fetch('/api/logs/clear', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Error clearing logs');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error clearing logs');
            });
    }
}

function downloadLogs() {
    if (currentLogId && currentLogType) {
        window.location.href = `/api/logs/${currentLogType}/${currentLogId}/download`;
    }
}
</script>
{% endblock %}