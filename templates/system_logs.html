{% extends "base.html" %}

{% block title %}System Logs - Dynamic Servers{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="display-6 mb-0">
                    <i class="fas fa-file-alt text-primary me-2"></i>System Logs
                </h1>
                <p class="text-muted">View deployment logs, system updates, and operation history</p>
            </div>
            <div>
                <button type="button" class="btn btn-outline-secondary" onclick="refreshLogs()">
                    <i class="fas fa-sync me-1"></i>Refresh
                </button>
                <button type="button" class="btn btn-outline-danger" onclick="clearLogs()">
                    <i class="fas fa-trash me-1"></i>Clear Logs
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Filter Controls -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0">
            <div class="card-body">
                <form id="filter-form" class="row g-3">
                    <div class="col-md-3">
                        <label for="search" class="form-label">Search</label>
                        <input type="text" class="form-control" id="search" name="search" 
                               placeholder="Server name, operation...">
                    </div>
                    <div class="col-md-2">
                        <label for="log_type" class="form-label">Log Type</label>
                        <select class="form-select" id="log_type" name="log_type">
                            <option value="">All Types</option>
                            <option value="deployment">Deployment</option>
                            <option value="backup">Backup</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" name="status">
                            <option value="">All Statuses</option>
                            <option value="completed">Completed</option>
                            <option value="running">Running</option>
                            <option value="failed">Failed</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="server" class="form-label">Server</label>
                        <select class="form-select" id="server" name="server">
                            <option value="">All Servers</option>
                            {% for server in servers %}
                            <option value="{{ server.id }}">{{ server.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-flex gap-1">
                            <button type="submit" class="btn btn-primary" id="filter-btn">
                                <i class="fas fa-search me-1" id="filter-icon"></i>
                                <span id="filter-text">Filter</span>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="clear-btn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- System Updates Logs -->
<div class="card border-0 mb-4">
    <div class="card-header bg-gradient">
        <h5 class="card-title mb-0">
            <i class="fas fa-arrow-up me-2"></i>Deployment Script Executions
        </h5>
    </div>
    <div class="card-body p-0">
        <div id="updates-content">
        {% if updates %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Server</th>
                        <th>Script Type</th>
                        <th>Status</th>
                        <th>Started</th>
                        <th>Duration</th>
                        <th>Initiated By</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for update in updates %}
                    <tr class="log-row" data-type="deployment" data-server="{{ update.server_id }}">
                        <td>
                            <div class="fw-bold">{{ update.server.name if update.server else 'Unknown' }}</div>
                            <small class="text-muted">{{ update.server.public_ip if update.server else 'N/A' }}</small>
                        </td>
                        <td>
                            <span class="badge bg-info">{{ update.update_type.title() }}</span>
                        </td>
                        <td>
                            {% if update.status == 'completed' %}
                            <span class="badge bg-success">Completed</span>
                            {% elif update.status == 'failed' %}
                            <span class="badge bg-danger">Failed</span>
                            {% elif update.status == 'running' %}
                            <span class="badge bg-warning">Running</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ update.status.title() }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <small>{{ update.started_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                        </td>
                        <td>
                            {% if update.completed_at and update.started_at %}
                            <small>{{ ((update.completed_at - update.started_at).total_seconds())|int }}s</small>
                            {% else %}
                            <small class="text-muted">-</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if update.initiated_by_user %}
                            <small>{{ update.initiated_by_user.username }}</small>
                            {% else %}
                            <small class="text-muted">System</small>
                            {% endif %}
                        </td>
                        <td>
                            <button type="button" class="btn btn-outline-primary btn-sm" 
                                    onclick="viewLogs({{ update.id }}, 'update')" title="View Logs">
                                <i class="fas fa-eye"></i>
                            </button>
                            {% if update.status == 'failed' %}
                            <button type="button" class="btn btn-outline-danger btn-sm" 
                                    onclick="viewErrors({{ update.id }}, 'update')" title="View Errors">
                                <i class="fas fa-exclamation-triangle"></i>
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5" id="no-updates-message">
            <i class="fas fa-file-alt fa-4x text-muted mb-3"></i>
            <h3 class="text-muted">No Deployment Logs</h3>
            <p class="text-muted">No deployment script executions found.</p>
        </div>
        {% endif %}
        </div>
    </div>
</div>

<!-- Database Backups Logs -->
<div class="card border-0 mb-4">
    <div class="card-header bg-gradient">
        <h5 class="card-title mb-0">
            <i class="fas fa-database me-2"></i>Database Backup Operations
        </h5>
    </div>
    <div class="card-body p-0">
        <div id="backups-content">
        {% if backups %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Database</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Started</th>
                        <th>Size</th>
                        <th>Initiated By</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for backup in backups %}
                    <tr class="log-row" data-type="backup" data-server="{{ backup.server_id }}">
                        <td>
                            <div class="fw-bold">{{ backup.database_name }}</div>
                            <small class="text-muted">{{ backup.server.name if backup.server else 'Local' }}</small>
                        </td>
                        <td>
                            <span class="badge bg-secondary">{{ backup.backup_type.title() }}</span>
                        </td>
                        <td>
                            {% if backup.status == 'completed' %}
                            <span class="badge bg-success">Completed</span>
                            {% elif backup.status == 'failed' %}
                            <span class="badge bg-danger">Failed</span>
                            {% elif backup.status == 'running' %}
                            <span class="badge bg-warning">Running</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ backup.status.title() }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <small>{{ backup.started_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                        </td>
                        <td>
                            {% if backup.file_size %}
                            <small>{{ "%.2f"|format(backup.file_size / 1024 / 1024) }} MB</small>
                            {% else %}
                            <small class="text-muted">-</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if backup.initiated_by_user %}
                            <small>{{ backup.initiated_by_user.username }}</small>
                            {% else %}
                            <small class="text-muted">System</small>
                            {% endif %}
                        </td>
                        <td>
                            <button type="button" class="btn btn-outline-primary btn-sm" 
                                    onclick="viewLogs({{ backup.id }}, 'backup')" title="View Logs">
                                <i class="fas fa-eye"></i>
                            </button>
                            {% if backup.status == 'failed' %}
                            <button type="button" class="btn btn-outline-danger btn-sm" 
                                    onclick="viewErrors({{ backup.id }}, 'backup')" title="View Errors">
                                <i class="fas fa-exclamation-triangle"></i>
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5" id="no-backups-message">
            <i class="fas fa-database fa-4x text-muted mb-3"></i>
            <h3 class="text-muted">No Backup Logs</h3>
            <p class="text-muted">No database backup operations found.</p>
        </div>
        {% endif %}
        </div>
    </div>
</div>

<!-- Log Detail Modal -->
<div class="modal fade" id="logDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logModalTitle">Operation Logs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Execution Output:</label>
                    <pre id="executionLogs" class="bg-dark text-light p-3 rounded" style="max-height: 300px; overflow-y: auto;"></pre>
                </div>
                <div id="errorSection" style="display: none;">
                    <label class="form-label">Error Output:</label>
                    <pre id="errorLogs" class="bg-danger text-white p-3 rounded" style="max-height: 200px; overflow-y: auto;"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="downloadLogs()">
                    <i class="fas fa-download me-1"></i>Download Logs
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentLogId = null;
let currentLogType = null;

// AJAX Filtering
document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('filter-form');
    const filterBtn = document.getElementById('filter-btn');
    const filterIcon = document.getElementById('filter-icon');
    const filterText = document.getElementById('filter-text');
    const clearBtn = document.getElementById('clear-btn');
    const updatesContent = document.getElementById('updates-content');
    const backupsContent = document.getElementById('backups-content');
    
    const searchInput = document.getElementById('search');
    const logTypeSelect = document.getElementById('log_type');
    const statusSelect = document.getElementById('status');
    const serverSelect = document.getElementById('server');
    
    let filterTimeout;
    
    function setFilterLoading(loading) {
        if (loading) {
            filterBtn.disabled = true;
            filterIcon.className = 'fas fa-spinner fa-spin me-1';
            filterText.textContent = 'Filtering...';
        } else {
            filterBtn.disabled = false;
            filterIcon.className = 'fas fa-search me-1';
            filterText.textContent = 'Filter';
        }
    }
    
    function renderUpdatesTable(updates) {
        if (updates.length === 0) {
            return `
                <div class="text-center py-5" id="no-updates-message">
                    <i class="fas fa-file-alt fa-4x text-muted mb-3"></i>
                    <h3 class="text-muted">No Deployment Logs</h3>
                    <p class="text-muted">No deployment logs match your filters.</p>
                </div>
            `;
        }
        
        let html = `
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Server</th>
                            <th>Script Type</th>
                            <th>Status</th>
                            <th>Started</th>
                            <th>Duration</th>
                            <th>Initiated By</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        updates.forEach(update => {
            const statusClass = update.status === 'completed' ? 'bg-success' : 
                               update.status === 'failed' ? 'bg-danger' : 
                               update.status === 'running' ? 'bg-warning' : 'bg-secondary';
            
            html += `
                <tr class="log-row" data-type="deployment" data-server="${update.server_id}">
                    <td>
                        <div class="fw-bold">${update.server_name}</div>
                        <small class="text-muted">${update.server_ip}</small>
                    </td>
                    <td>
                        <span class="badge bg-info">${update.update_type.charAt(0).toUpperCase() + update.update_type.slice(1)}</span>
                    </td>
                    <td>
                        <span class="badge ${statusClass}">${update.status.charAt(0).toUpperCase() + update.status.slice(1)}</span>
                    </td>
                    <td>
                        <small>${update.started_at}</small>
                    </td>
                    <td>
                        ${update.duration ? `<small>${update.duration}s</small>` : '<small class="text-muted">-</small>'}
                    </td>
                    <td>
                        <small>${update.initiated_by}</small>
                    </td>
                    <td>
                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                onclick="viewLogs(${update.id}, 'update')" title="View Logs">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${update.status === 'failed' ? `
                            <button type="button" class="btn btn-outline-danger btn-sm" 
                                    onclick="viewErrors(${update.id}, 'update')" title="View Errors">
                                <i class="fas fa-exclamation-triangle"></i>
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        return html;
    }
    
    function renderBackupsTable(backups) {
        if (backups.length === 0) {
            return `
                <div class="text-center py-5" id="no-backups-message">
                    <i class="fas fa-database fa-4x text-muted mb-3"></i>
                    <h3 class="text-muted">No Backup Logs</h3>
                    <p class="text-muted">No backup logs match your filters.</p>
                </div>
            `;
        }
        
        let html = `
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Database</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Started</th>
                            <th>Size</th>
                            <th>Initiated By</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        backups.forEach(backup => {
            const statusClass = backup.status === 'completed' ? 'bg-success' : 
                               backup.status === 'failed' ? 'bg-danger' : 
                               backup.status === 'running' ? 'bg-warning' : 'bg-secondary';
            
            html += `
                <tr class="log-row" data-type="backup" data-server="${backup.server_id}">
                    <td>
                        <div class="fw-bold">${backup.database_name}</div>
                        <small class="text-muted">${backup.server_name}</small>
                    </td>
                    <td>
                        <span class="badge bg-secondary">${backup.backup_type.charAt(0).toUpperCase() + backup.backup_type.slice(1)}</span>
                    </td>
                    <td>
                        <span class="badge ${statusClass}">${backup.status.charAt(0).toUpperCase() + backup.status.slice(1)}</span>
                    </td>
                    <td>
                        <small>${backup.started_at}</small>
                    </td>
                    <td>
                        ${backup.file_size ? `<small>${(backup.file_size / 1024 / 1024).toFixed(2)} MB</small>` : '<small class="text-muted">-</small>'}
                    </td>
                    <td>
                        <small>${backup.initiated_by}</small>
                    </td>
                    <td>
                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                onclick="viewLogs(${backup.id}, 'backup')" title="View Logs">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${backup.status === 'failed' ? `
                            <button type="button" class="btn btn-outline-danger btn-sm" 
                                    onclick="viewErrors(${backup.id}, 'backup')" title="View Errors">
                                <i class="fas fa-exclamation-triangle"></i>
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        return html;
    }
    
    function performFilter() {
        setFilterLoading(true);
        
        const formData = new FormData(filterForm);
        const params = new URLSearchParams(formData);
        
        fetch('/system-logs?' + params, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            setFilterLoading(false);
            
            if (data.success) {
                updatesContent.innerHTML = renderUpdatesTable(data.updates);
                backupsContent.innerHTML = renderBackupsTable(data.backups);
            } else {
                console.error('Filter failed:', data.error);
            }
        })
        .catch(error => {
            setFilterLoading(false);
            console.error('Error:', error);
        });
    }
    
    // Handle form submission
    filterForm.addEventListener('submit', function(e) {
        e.preventDefault();
        performFilter();
    });
    
    // Real-time filtering with debounce
    function handleInputChange() {
        clearTimeout(filterTimeout);
        filterTimeout = setTimeout(performFilter, 500);
    }
    
    searchInput.addEventListener('input', handleInputChange);
    logTypeSelect.addEventListener('change', performFilter);
    statusSelect.addEventListener('change', performFilter);
    serverSelect.addEventListener('change', performFilter);
    
    // Clear filters
    clearBtn.addEventListener('click', function() {
        searchInput.value = '';
        logTypeSelect.value = '';
        statusSelect.value = '';
        serverSelect.value = '';
        performFilter();
    });
});

function viewLogs(logId, logType) {
    currentLogId = logId;
    currentLogType = logType;
    
    // Make AJAX request to get log details
    fetch(`/api/logs/${logType}/${logId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('logModalTitle').textContent = 
                `${logType.charAt(0).toUpperCase() + logType.slice(1)} Logs - ${data.description || 'Operation'}`;
            
            document.getElementById('executionLogs').textContent = 
                data.execution_log || 'No execution logs available';
            
            if (data.error_log) {
                document.getElementById('errorSection').style.display = 'block';
                document.getElementById('errorLogs').textContent = data.error_log;
            } else {
                document.getElementById('errorSection').style.display = 'none';
            }
            
            const modal = new bootstrap.Modal(document.getElementById('logDetailModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error fetching logs:', error);
            alert('Error loading logs. Please try again.');
        });
}

function viewErrors(logId, logType) {
    viewLogs(logId, logType); // Same as view logs, but will show errors section
}

function refreshLogs() {
    window.location.reload();
}

function clearLogs() {
    if (confirm('Clear all logs? This action cannot be undone.')) {
        fetch('/api/logs/clear', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Error clearing logs');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error clearing logs');
            });
    }
}

function downloadLogs() {
    if (currentLogId && currentLogType) {
        window.location.href = `/api/logs/${currentLogType}/${currentLogId}/download`;
    }
}
</script>
{% endblock %}